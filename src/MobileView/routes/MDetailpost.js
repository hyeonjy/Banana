import { Link, useHistory, useParams } from "react-router-dom";
import styled, { css, keyframes } from "styled-components";
import { ItemObj } from "../../Data/ItemObj";
import banana from "../../Img/banana.png";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import {
  faChevronLeft,
  faHouse,
  faSeedling,
} from "@fortawesome/free-solid-svg-icons";

import { Swiper, SwiperSlide } from "swiper/react";
// Import Swiper styles
import "swiper/css";
import "swiper/css/navigation";
import "swiper/css/pagination";
import "swiper/swiper-bundle.css";
import { Navigation, Pagination } from "swiper";
import { useState } from "react";
import { faHeart } from "@fortawesome/free-regular-svg-icons";
import User from "../components/User";
import Modal from "../../Modal";
import { LoginId, UserObj } from "../../Data/UserObj";
import { useEffect } from "react";

const Container = styled.div`
  background-color: white;
  filter: ${(props) => (props.activeGrade ? "blur(2px)" : "unset")};
  ${(props) => {
    if (props.activeGrade) {
      return css`
        height: 100vh;
      `;
    }
  }}
`;

const Box = styled.div`
  display: flex;
  padding: 10px 20px;
  border-bottom: 1px solid #e9ecef;
`;

// Header
const Header = styled.div`
  width: 90%;
  height: 25px;
  padding: 15px 5%;
  background-color: yellow;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 15px;
  color: #37352f;
  position: fixed;
  z-index: 2;
  top: ${(props) => (props.activeGrade ? "-56px" : "0")};
`;

const HeaderTitle = styled.span`
  font-size: 15px;
  font-weight: 600;
  margin-left: 5px;
`;

const PrevIcon = styled(FontAwesomeIcon)`
  font-size: 20px;
`;

// 게시글(제목, 서브제목, 이미지 내용)
const Post = styled(Box)`
  flex-direction: column;
  border-bottom: none;
`;

const PostTitle = styled.h1`
  font-size: 18px;
  font-weight: 700;
  line-height: 30px;
  margin-bottom: 3px;
`;

const PostSubtitle = styled.span`
  font-size: 12px;
  color: rgba(0, 0, 0, 0.3);
`;

const PostImg = styled.img`
  width: 100%;
  height: 350px;
  object-fit: cover;
`;

const PostContent = styled.div`
  padding: 20px;
  padding-top: 0px;
  font-size: 14.5px;
  line-height: 25px;
`;

// 게시글(좋아요, 조회수)
const PostMore = styled.div`
  padding: 15px;
  display: flex;
  align-items: center;
  //border-bottom: 1px solid #e9ecef;
  color: rgba(0, 0, 0, 0.5);
  svg {
    transition: all 0.3s;
    cursor: pointer;
  }
`;

const heartAnimation = keyframes`
  0%{
    transform: none;
  }
  60%{
    transform: scale(1.3);
  }
  100%{
    transform: none;
  }
`;

const HeartSvg = styled.svg`
  margin-right: 7px;
  ${(props) =>
    props.heart &&
    css`
      animation: ${heartAnimation} 0.3s 1 linear;
    `}
`;

const Morehits = styled.span`
  font-size: 13px;
`;

// 채팅하기 버튼
const ChatBtn = styled.div`
  width: fit-content;
  background-color: rgb(255, 181, 45);
  position: fixed;
  right: 22px;
  bottom: 20px;
  border-radius: 20px;
  height: fit-content;
  padding: 15px;
  letter-spacing: 0.5px;
  color: white;
  font-weight: 700;
  font-size: 14.5px;
`;

export const StateSelect = styled.select`
  background-color: white;
  border: 1px solid #808080a6;
  padding: 5px;
  width: 90px;

  border-radius: 5px;
  font-size: 13px;
`;

function MDetailpost(props) {
  const [hits, setHits] = useState(123); /**조회수 */
  const [heart, setHeart] = useState(false); /**좋아요 */
  const [index, setIndex] = useState(0); /**사진 인덱스 */
  const { postId } = useParams();
  const history = useHistory();

  const [activeGrade, setActiveGrade] = useState(false);

  // url 파라미터를 통해 맞는 옷 상품 가져오기
  const filterItemObj = ItemObj.find((item) => item.itemId === Number(postId));
  // 작성자 user obj
  const FilterUserObj = UserObj.find(
    (user) => user.id === filterItemObj.userId
  );
  // 본인 글인지 확인
  const isWriter = FilterUserObj.id === LoginId;

  //나눔 상태 변경
  const [SelectedState, setSelected] = useState(filterItemObj.state);

  useEffect(() => {
    filterItemObj.state = SelectedState;
  }, [SelectedState]);

  const handleChangeSelect = (e) => {
    setSelected(e.target.value);
  };

  //img 클릭 시 Fullscreen
  function handleImageClick(props) {
    const searchParams = new URLSearchParams();
    searchParams.append("object", postId);
    searchParams.append("index", index);
    history.push({
      pathname: "/images",
      search: "?" + searchParams.toString(),
    });
  }

  // swiper onSlideChange 시 - 현재 img index 저장
  const handleSlideChange = (currentIndex) => {
    setIndex(currentIndex.activeIndex);
  };

  //채팅목록 클릭 이벤트
  const handleChatClick = (userId, postId) => {
    const searchParams = new URLSearchParams();
    searchParams.append("userId", userId);
    searchParams.append("itemId", postId);
    history.push({
      pathname: "/chat",
      search: "?" + searchParams.toString(),
    });
  };

  return (
    <>
      <Container activeGrade={activeGrade}>
        {/* Header */}
        <Header activeGrade={activeGrade}>
          <PrevIcon
            onClick={() => {
              history.goBack();
            }}
            icon={faChevronLeft}
          />
          <HeaderTitle>BANANA</HeaderTitle>
          <Link to="/">
            <PrevIcon icon={faHouse} />
          </Link>
        </Header>
        {/* 유저 정보 */}
        <User
          userId={FilterUserObj.id}
          img={FilterUserObj.src}
          grade={FilterUserObj.grade}
          setActiveGrade={setActiveGrade}
          profile="true"
        />
        {/* 게시글 이미지  */}
        {/* 사진 클릭하면 Mimages.js로 이동, obj와 클릭한 사진 인덱스 전달 */}
        <Swiper
          modules={[Navigation, Pagination]}
          spaceBetween={0}
          slidesPerView={1}
          pagination={{ clickable: true }}
          onSwiper={(swiper) => {}}
          onSlideChange={handleSlideChange}
        >
          {filterItemObj.img.map((img, index) => {
            return (
              <SwiperSlide key={index} onClick={handleImageClick}>
                <PostImg src={require(`../../Img/${img}.jpg`)} />
              </SwiperSlide>
            );
          })}
        </Swiper>
        {/* 게시글 제목 - 카테고리|지역|시간 */}
        <Post>
          <div style={{ display: "flex", justifyContent: "space-between" }}>
            <PostTitle>{filterItemObj.title}</PostTitle>
            {isWriter && (
              <StateSelect value={SelectedState} onChange={handleChangeSelect}>
                <option value="wait">대기중</option>
                <option value="reservate">예약중</option>
                <option value="complete">나눔완료</option>
              </StateSelect>
            )}
          </div>

          <PostSubtitle>
            {filterItemObj.sub} | {filterItemObj.area} | {filterItemObj.timeAgo}
          </PostSubtitle>
        </Post>
        {/* 게시글 내용 */}
        <PostContent>{filterItemObj.content}</PostContent>
        {/* 게시글 하트, 조회수 */}
        <PostMore>
          <HeartSvg
            heart={heart}
            width="30"
            height="30"
            viewBox="12 10 30 40"
            fill={heart ? "tomato" : "none"}
            stroke="rgba(0, 0, 0, 0.5)"
            strokeWidth="1.3"
            onClick={() => setHeart(!heart)}
          >
            <path d="M29.144 20.773c-.063-.13-4.227-8.67-11.44-2.59C7.63 28.795 28.94 43.256 29.143 43.394c.204-.138 21.513-14.6 11.44-25.213-7.214-6.08-11.377 2.46-11.44 2.59z" />
          </HeartSvg>
          <Morehits>조회수 {filterItemObj.meta.view}</Morehits>
        </PostMore>
        {/* 채팅하기 버튼 */}
        {isWriter ? (
          <ChatBtn>삭제하기</ChatBtn>
        ) : (
          <ChatBtn onClick={() => handleChatClick(FilterUserObj.id, postId)}>
            채팅하기
          </ChatBtn>
        )}
      </Container>
      {activeGrade && (
        <Modal setActiveGrade={setActiveGrade} isMobile={"true"} />
      )}
    </>
  );
}

export default MDetailpost;
